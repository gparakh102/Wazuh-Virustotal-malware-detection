<h1>Malware Detection using Wazuh and Virustotal</h1>

<h2>Description</h2>
In cybersecurity, early detection of threats is crucial. During this lab, Wazuh and VirusTotal were utilized for real-time malware detection. Recognizing malware early is vital for preventing breaches and data risks. Rather than relying solely on traditional antivirus solutions, integrating VirusTotal with Wazuh SIEM allows scrutiniy of suspicious files effectively, thereby enhancing defenses. This combined approach strengthens the network's ability to respond swiftly to emerging threats.<br/><br />

Special acknowledgments and credits to Mr. Rajneesh Gupta for his invaluable contributions and guidance.<br/><br/>
<br />



<h2>Requirements </h2>

- <b>Virtal Box</b>
- <b>Windows 10/11 VM</b>
- <b>Wazuh OVA File (required at least 8GB RAM and 4 cores)</b>

<h2>Practical lab walk-through:</h2><br/>

<p>
<h2><b>Sections:- </b></h2>
<h3><b>1. Set up Wazuh on Virtual Box</b></h3>
<h3><b>2. Set up VirusTotal account and retrieve API key</b></h3>
<h3><b>3. Integrate Virustotal on Wazuh Manager</b></h3>
<h3><b>4. Setting up Wazuh Agent to detect file changes</b></h3>
<h3><b>5. Adding malware to see if the Wazuh Agent detects file changes</b></h3>
<br/><br/><br/>
 
<h3><b>1: Set up Wazuh and Windows 10 VM on Virtual Box</b></h3>
<br/>
- Download and install <a href="https://www.virtualbox.org/wiki/Downloads">Virtual Box</a> <br />
<img src="https://i.postimg.cc/pLJQB8xD/1.png" height="50%" width="50%" alt="Steps"/><br /><br />
- Download and install <a href="https://developer.microsoft.com/en-us/windows/downloads/virtual-machines/">Windows 10/11 Virtual Edition</a>on Virtual Box
<br />
<img src="https://i.postimg.cc/vHW2p4bm/69-1.png" height="50%" width="50%" alt="Steps"/>
<br />
<br />
- Download the <a href="https://documentation.wazuh.com/current/deployment-options/virtual-machine/virtual-machine.html">Wazuh OVA file</a>
<br />
<img src="https://i.postimg.cc/KcpnqFdH/1.png" height="50%" width="50%" alt="Steps"/>
<br />
<br />
- Open the OVA file in Virtualbox<br />
<img src="https://i.postimg.cc/Qt33ZRvL/69.png" height="50%" width="50%" alt="Steps"/>
<br /><br />
- Now, log in to Wazuh CLI and run <b><i>ifconfig</i></b> to get the IP address.
- The default Wazuh CLI credential is <br />
username: wazuh-user<br />
password: wazuh<br />
<img src="https://i.postimg.cc/3JP2h1rj/1.png" height="50%" width="50%" alt="Steps"/>
<br /><br />
- On obtaining the IP address, open the browser on the Windows 10 VM and type the URL https://<WAZUH_IP_ADDRESS> (In my case it is "https://192.168.0.152" Clicking on it won't work as the Wazuh VM is not up on my side)<br /><br />
- The Wazuh GUI credentials are:-<br />
username: admin<br />
password: admin<br />
<img src="https://i.postimg.cc/wBzJyBm7/2.png" height="50%" width="50%" alt="Steps"/>
<br /><br />
- Once logged in, click on <b><i>Add Agent</i></b>, as in image below<br /> 
<img src="https://i.postimg.cc/sXDhm0Kz/3.png" height="50%" width="50%" alt="Steps"/><br /><br />
- Next, select the Operating system on which the agent will be installed, and enter the Wazuh Server address as below<br />
<img src="https://i.postimg.cc/wvfsGcbm/4.png" height="50%" width="50%" alt="Steps"/><br /><br />
- At the end, a PowerShell script and a command to start the Wazuh service is displayed. Run the script on powershell in the Windows VM and after it is successfully finished running, start the Wazuh agent<br />
<img src="https://i.postimg.cc/JzZZzXtf/5.png" height="50%" width="50%" alt="Steps"/><br />
<img src="https://i.postimg.cc/28qngMY8/6.png" height="50%" width="50%" alt="Steps"/><br /><br />
- Finally, back on the Wazuh platform the newly onboarded Windows agent is now visible<br />
<img src="https://i.postimg.cc/g0KhvPV4/7.png" height="50%" width="50%" alt="Steps"/><br /><br /><br />



<h3><b>2: Set up VirusTotal account and retrieve API key</b></h3>
- Visit <a href="https://www.virustotal.com/gui/home/upload">virustotal</a> and sign up with an email address.<br />
- Go to <b><i>profile</i></b> and then <b><i>API key</i></b><br />
- Now, copy the API key and save it someplace safe for easy access.<br /><br />
- This is my personal API key which is hidden. Follow the steps above to receive a personalized key.<br />
<img src="https://i.postimg.cc/RZ7JBzD9/API-key.png" height="50%" width="50%" alt="Steps"/><br /><br /><br />



<h3><b>3: Integrate Virustotal on Wazuh Manager</b></h3>
- Login to Wazuh Manager and open the <b><i>ossec.conf</i></b> file located at <b><i>view > view config</i></b><br />
<img src="https://i.postimg.cc/J4BBpX3s/8.png" height="50%" width="50%" alt="Steps"/><br /><br />
- Next add the block of code given below, at the end within the <ossec_config> tag<br /><br />

 <pre>

  &lt;integration&gt;

    &lt;name&gt;virustotal&lt;/name&gt;

    &lt;api_key&gt;&lt;ENTER_PERSONALIZED_VIRUSTOTAL_API_KEY&gt;&lt;/api_key&gt;

    &lt;group&gt;syscheck&lt;/group&gt;

    &lt;alert_format&gt;json&lt;/alert_format&gt;

  &lt;/integration&gt;

</pre>

<br /><br />
- Now, restart the wazuh Manager<br />
<img src="https://i.postimg.cc/5yDQx9J9/9.png" height="50%" width="50%" alt="Steps"/><br /><br /><br />



<h3><b>4: Setting up Wazuh Agent to detect file changes</b></h3>
- Search for the &lt;syscheck&gt; block in the location of the <b><i>ossec.conf</i></b> file.<br /> 
- Make sure that &lt;disabled&gt; is set to "no" as it allows the Wazuh FIM module to monitor changes.<br />
- Add the code in the image below, within the &lt;syscheck&gt; block to configure a directory to be monitored real-time.<br /><br /> 
<img src="https://i.postimg.cc/1X4nYFr4/13-1.png" height="50%" width="50%" alt="Steps"/><br /><br /><br />
- In this lab, we will download and add a malware sample in this Documents folder to check if there has been a change where a malicious file has been added.<br />
- Now, restart the wazuh agent again to apply the changes.<br />
<img src="https://i.postimg.cc/5yDQx9J9/9.png" height="50%" width="50%" alt="Steps"/><br /><br /><br />



<h3><b>5: Adding malware to see if the Wazuh Agent detects file changes</b></h3>
- In this step, use of the <a href="https://www.eicar.org/download-anti-malware-testfile/">eicar</a> test file is required. <br />
- This is from their official website<br /><br />
NOTE: This is a malicious file and must be only downloaded for educational/research purposes. <br />
To download it, one must disable the enhanced security option on Google Chrome and Real-time Security on Windows Defender.(Download on VM only)<br /><br />
- Now, move the file into Document folder.<br />
- Once done, the alert is visible on Wazuh as shown below.<br />
- It says a new file has been added.<br />
<img src="https://i.postimg.cc/hvX7WzH3/11.png" height="50%" width="50%" alt="Steps"/><br /><br /><br />


</p>
<!--
 ```diff
- text in red
+ text in green
! text in orange
# text in gray
@@ text in purple (and bold)@@
```
--!>
